<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ—…è¡Œç¿»è­¯æ©Ÿ">
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>ğŸŒ</text></svg>">
<title>æ—…è¡Œç¿»è­¯æ©Ÿ</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f172a;--surface:#1e293b;--surface2:#334155;
  --text:#f1f5f9;--text2:#94a3b8;--accent:#38bdf8;--accent2:#818cf8;
  --danger:#f87171;--radius:16px;
}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans",sans-serif}
body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;overflow:hidden}

/* Header */
.header{padding:12px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--surface2)}
.header h1{font-size:18px;font-weight:700;flex:1}
.settings-btn{
  background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;
  padding:4px 8px;border-radius:8px;transition:color .15s;
}
.settings-btn:hover,.settings-btn:active{color:var(--text)}

/* Modal */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;
  display:flex;align-items:center;justify-content:center;padding:16px;
}
.modal-overlay.hidden{display:none}
.modal{
  background:var(--surface);border-radius:var(--radius);padding:24px;
  width:100%;max-width:400px;display:flex;flex-direction:column;gap:16px;
}
.modal h2{font-size:18px;font-weight:700}
.modal p{font-size:13px;color:var(--text2);line-height:1.5}
.modal input{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--surface2);
  background:var(--bg);color:var(--text);font-size:15px;outline:none;
  font-family:monospace;
}
.modal input:focus{border-color:var(--accent)}
.modal-btns{display:flex;gap:8px;justify-content:flex-end}
.modal-btns button{
  padding:10px 20px;border:none;border-radius:12px;font-size:15px;
  font-weight:600;cursor:pointer;
}
.btn-primary{background:var(--accent);color:#0f172a}
.btn-cancel{background:var(--surface2);color:var(--text)}

/* Text input area */
.input-bar{padding:12px 16px;display:flex;gap:8px}
.input-bar input{
  flex:1;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--surface2);
  background:var(--surface);color:var(--text);font-size:16px;outline:none;
}
.input-bar input::placeholder{color:var(--text2)}
.input-bar input:focus{border-color:var(--accent)}
.input-bar button{
  padding:10px 18px;border:none;border-radius:var(--radius);
  background:var(--accent);color:#0f172a;font-weight:700;font-size:15px;cursor:pointer;
  white-space:nowrap;
}

/* Main content area */
.main{flex:1;overflow-y:auto;padding:0 16px 16px;display:flex;flex-direction:column;gap:16px}

/* Result card */
.result-card{
  background:var(--surface);border-radius:var(--radius);padding:20px;
  text-align:center;min-height:100px;display:flex;flex-direction:column;
  justify-content:center;align-items:center;gap:8px;cursor:pointer;
  transition:background .15s;flex-shrink:0;
}
.result-card:active{background:var(--surface2)}
.result-card .translation{font-size:clamp(20px,8vw,36px);font-weight:700;line-height:1.3;word-break:break-word}
.result-card .translation.long{font-size:clamp(16px,5vw,24px)}
.result-card .romaji{font-size:18px;color:var(--accent);margin-top:4px}
.result-card .original{font-size:14px;color:var(--text2);margin-top:8px}
.result-card .tap-hint{font-size:11px;color:var(--text2);margin-top:6px;opacity:.6}
.result-card.empty{cursor:default;color:var(--text2);font-size:15px}
.result-card.empty:active{background:var(--surface)}

/* Lang toggle */
.lang-toggle{
  display:flex;align-items:center;justify-content:center;gap:0;flex-shrink:0;padding:0 16px 4px;
}
.lang-toggle button{
  padding:8px 20px;border:1px solid var(--surface2);background:var(--surface);
  color:var(--text2);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;
}
.lang-toggle button:first-child{border-radius:var(--radius) 0 0 var(--radius)}
.lang-toggle button:last-child{border-radius:0 var(--radius) var(--radius) 0}
.lang-toggle button.active{background:var(--accent);color:#0f172a;border-color:var(--accent)}

/* Photo results */
.photo-results{
  background:var(--surface);border-radius:var(--radius);overflow:hidden;flex-shrink:0;
}
.photo-results-header{
  padding:14px 20px;font-size:14px;font-weight:600;color:var(--accent);
  border-bottom:1px solid var(--surface2);
}
.photo-line{
  padding:14px 20px;cursor:pointer;transition:background .15s;
  border-bottom:1px solid var(--surface2);
}
.photo-line:last-child{border-bottom:none}
.photo-line:active{background:var(--surface2)}
.photo-line .pl-original{font-size:13px;color:var(--text2);line-height:1.4}
.photo-line .pl-translation{font-size:20px;font-weight:600;line-height:1.4;margin-top:4px}
.photo-line .pl-romaji{font-size:13px;color:var(--accent);margin-top:2px}

/* Action buttons area */
.action-area{padding:12px 16px 16px;display:flex;justify-content:center;gap:12px;flex-shrink:0}
.action-btn{
  flex:1;max-width:200px;height:64px;border:none;border-radius:var(--radius);
  color:#fff;font-size:17px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:transform .1s,box-shadow .2s;user-select:none;
  -webkit-user-select:none;touch-action:manipulation;
}
.action-btn:active{transform:scale(.97)}
.mic-btn{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.mic-btn.recording{
  background:linear-gradient(135deg,var(--danger),#ef4444);
  animation:pulse 1s ease-in-out infinite;
}
.cam-btn{background:linear-gradient(135deg,var(--accent2),#a78bfa)}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(248,113,113,.5)}50%{box-shadow:0 0 0 16px rgba(248,113,113,0)}}

.action-btn svg{width:26px;height:26px;fill:currentColor}

/* History */
.history-title{font-size:13px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-top:8px}
.history-item{
  background:var(--surface);border-radius:12px;padding:14px;cursor:pointer;
  transition:background .15s;
}
.history-item:active{background:var(--surface2)}
.history-item .h-translation{font-size:22px;font-weight:600}
.history-item .h-romaji{font-size:13px;color:var(--accent);margin-top:2px}
.history-item .h-original{font-size:13px;color:var(--text2);margin-top:4px}

/* Loading spinner */
.loading{display:none;align-items:center;justify-content:center;gap:8px;padding:20px;color:var(--text2);font-size:15px}
.loading.show{display:flex}
.spinner{width:20px;height:20px;border:3px solid var(--surface2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Status text */
.status{text-align:center;font-size:13px;color:var(--text2);padding:4px 16px;min-height:22px}
</style>
</head>
<body>

<!-- API Key Modal -->
<div class="modal-overlay hidden" id="keyModal">
  <div class="modal">
    <h2>è¨­å®š API Key</h2>
    <p>è«‹è¼¸å…¥ä½ çš„ Gemini API Keyã€‚<br>Key åªæœƒå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚</p>
    <input id="keyInput" type="password" placeholder="AIzaSy...">
    <div class="modal-btns">
      <button class="btn-cancel" id="keyCancelBtn">å–æ¶ˆ</button>
      <button class="btn-primary" id="keySaveBtn">å„²å­˜</button>
    </div>
  </div>
</div>

<div class="header">
  <span style="font-size:24px">ğŸŒ</span>
  <h1>æ—…è¡Œç¿»è­¯æ©Ÿ</h1>
  <button class="settings-btn" id="settingsBtn" title="è¨­å®š API Key">&#9881;</button>
</div>

<div class="input-bar">
  <input id="textInput" type="text" placeholder="è¼¸å…¥ä¸­æ–‡æˆ–æ—¥æ–‡..." enterkeyhint="send">
  <button id="sendBtn">ç¿»è­¯</button>
</div>

<div class="status" id="status"></div>

<div class="main" id="mainArea">
  <div class="result-card empty" id="resultCard">
    <span>æŒ‰ä½ä¸‹æ–¹æŒ‰éˆ•èªªè©±<br>æˆ–åœ¨ä¸Šæ–¹è¼¸å…¥æ–‡å­—</span>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <span>ç¿»è­¯ä¸­...</span>
  </div>

  <div id="historyContainer"></div>
</div>

<div class="lang-toggle" id="langToggle">
  <button class="active" data-lang="zh-TW">ä¸­æ–‡</button>
  <button data-lang="ja">æ—¥æœ¬èª</button>
</div>

<input type="file" id="camInput" accept="image/*" capture="environment" style="display:none">

<div class="action-area">
  <button class="action-btn mic-btn" id="micBtn">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    <span>èªªè©±</span>
  </button>
  <button class="action-btn cam-btn" id="camBtn">
    <svg viewBox="0 0 24 24"><path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/><path d="M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
    <span>æ‹ç…§</span>
  </button>
</div>

<script>
// -- API Key Management --
function getApiKey() { return localStorage.getItem('gemini_api_key') || ''; }
function setApiKey(key) { localStorage.setItem('gemini_api_key', key); }
function getGeminiUrl() {
  return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${getApiKey()}`;
}

const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¸­æ—¥ç¿»è­¯å°ˆå®¶ã€‚æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥çš„æ–‡å­—é€²è¡Œç¿»è­¯ï¼š
- å¦‚æœè¼¸å…¥æ˜¯ä¸­æ–‡ï¼ˆåŒ…å«ç¹é«”ä¸­æ–‡å’Œç°¡é«”ä¸­æ–‡ï¼‰ï¼Œç¿»è­¯æˆæ—¥æ–‡ï¼Œä¸¦é™„ä¸Šç¾…é¦¬æ‹¼éŸ³(romaji)ã€‚
- å¦‚æœè¼¸å…¥æ˜¯æ—¥æ–‡ï¼ˆåŒ…å«å¹³å‡åã€ç‰‡å‡åã€æ¼¢å­—æ··åˆçš„æ—¥æ–‡ï¼‰ï¼Œç¿»è­¯æˆä¸­æ–‡ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼Œromaji æ¬„ä½ç•™ç©ºå­—ä¸²ã€‚

ä½ åªèƒ½å›å‚³ç´” JSONï¼Œä¸è¦åŠ  markdown æ¨™è¨˜ã€ä¸è¦åŠ ä»»ä½•èªªæ˜æ–‡å­—ã€‚
å›å‚³æ ¼å¼ï¼š
{"translation":"ç¿»è­¯çµæœ","romaji":"ç¾…é¦¬æ‹¼éŸ³ï¼ˆåƒ…ä¸­æ–‡ç¿»æ—¥æ–‡æ™‚å¡«å¯«ï¼‰","detected_lang":"zhæˆ–ja"}`;

const PHOTO_PROMPT = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¸­æ—¥ç¿»è­¯å°ˆå®¶ã€‚è«‹è¾¨è­˜åœ–ç‰‡ä¸­æ‰€æœ‰å¯è¦‹çš„æ–‡å­—ï¼Œä¸¦é€æ®µç¿»è­¯ã€‚
- æ—¥æ–‡æ–‡å­—ç¿»è­¯æˆç¹é«”ä¸­æ–‡
- ä¸­æ–‡æ–‡å­—ç¿»è­¯æˆæ—¥æ–‡ï¼Œä¸¦é™„ä¸Šç¾…é¦¬æ‹¼éŸ³
- å°‡æ¯ä¸€æ®µæœ‰æ„ç¾©çš„æ–‡å­—åˆ†é–‹å›å‚³
- å¿½ç•¥ç„¡æ„ç¾©çš„ç¬¦è™Ÿæˆ–è£é£¾æ–‡å­—

ä½ åªèƒ½å›å‚³ç´” JSONï¼Œä¸è¦åŠ  markdown æ¨™è¨˜ã€ä¸è¦åŠ ä»»ä½•èªªæ˜æ–‡å­—ã€‚
å›å‚³æ ¼å¼ï¼š
{"lines":[{"original":"åŸæ–‡","translation":"ç¿»è­¯çµæœ","romaji":"ç¾…é¦¬æ‹¼éŸ³ï¼ˆåƒ…ä¸­ç¿»æ—¥æ™‚å¡«å¯«ï¼Œå¦å‰‡ç•™ç©ºå­—ä¸²ï¼‰","detected_lang":"zhæˆ–ja"}]}
å¦‚æœåœ–ç‰‡ä¸­æ²’æœ‰å¯è¾¨è­˜çš„æ–‡å­—ï¼Œå›å‚³ï¼š
{"lines":[]}`;

// -- Elements --
const micBtn = document.getElementById('micBtn');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const resultCard = document.getElementById('resultCard');
const loading = document.getElementById('loading');
const statusEl = document.getElementById('status');
const historyContainer = document.getElementById('historyContainer');
const mainArea = document.getElementById('mainArea');
const keyModal = document.getElementById('keyModal');
const keyInput = document.getElementById('keyInput');
const keySaveBtn = document.getElementById('keySaveBtn');
const keyCancelBtn = document.getElementById('keyCancelBtn');
const settingsBtn = document.getElementById('settingsBtn');
const camBtn = document.getElementById('camBtn');
const camInput = document.getElementById('camInput');

let history = JSON.parse(localStorage.getItem('translateHistory') || '[]');
let isRecording = false;
let recognition = null;
let speechLang = 'zh-TW';

// -- Lang Toggle --
const langToggle = document.getElementById('langToggle');
langToggle.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-lang]');
  if (!btn) return;
  speechLang = btn.dataset.lang;
  langToggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  textInput.placeholder = speechLang === 'zh-TW' ? 'è¼¸å…¥ä¸­æ–‡æˆ–æ—¥æ–‡...' : 'ä¸­å›½èªã‹æ—¥æœ¬èªã‚’å…¥åŠ›...';
});

// -- Key Modal --
function showKeyModal(cancellable) {
  keyInput.value = getApiKey();
  keyModal.classList.remove('hidden');
  keyCancelBtn.style.display = cancellable ? '' : 'none';
  keyInput.focus();
}

keySaveBtn.addEventListener('click', () => {
  const key = keyInput.value.trim();
  if (!key) { keyInput.focus(); return; }
  setApiKey(key);
  keyModal.classList.add('hidden');
  setStatus('API Key å·²å„²å­˜');
});

keyCancelBtn.addEventListener('click', () => { keyModal.classList.add('hidden'); });

keyInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') keySaveBtn.click();
});

settingsBtn.addEventListener('click', () => { showKeyModal(true); });

// First launch: show modal if no key
if (!getApiKey()) { showKeyModal(false); }

// -- Microphone Permission --
let micPermissionGranted = false;

async function ensureMicPermission() {
  if (micPermissionGranted) return true;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(t => t.stop());
    micPermissionGranted = true;
    return true;
  } catch (e) {
    setStatus('è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™');
    return false;
  }
}

// -- Speech Recognition Setup --
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜'); return null; }
  const r = new SR();
  r.continuous = false;
  r.interimResults = true;
  r.maxAlternatives = 1;
  r.lang = speechLang;
  return r;
}

async function toggleRecording() {
  if (isRecording) {
    stopRecording();
    return;
  }
  if (!getApiKey()) { showKeyModal(false); return; }

  const hasPermission = await ensureMicPermission();
  if (!hasPermission) return;

  recognition = initRecognition();
  if (!recognition) return;

  isRecording = true;
  micBtn.classList.add('recording');
  micBtn.querySelector('span').textContent = 'è†è½ä¸­...é»æ“Šåœæ­¢';
  setStatus('è«‹èªªè©±...');

  recognition.onresult = (e) => {
    let interim = '';
    let final = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        final += e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    // Show interim results in real time
    textInput.value = final || interim;
    if (final) {
      stopRecording();
      translate(final.trim());
    }
  };
  recognition.onerror = (e) => {
    if (e.error === 'no-speech') {
      setStatus('æœªåµæ¸¬åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡');
    } else {
      setStatus('èªéŸ³è¾¨è­˜éŒ¯èª¤: ' + e.error);
    }
    stopRecording();
  };
  recognition.onend = () => {
    // If we got no final result, try to use whatever we have
    const text = textInput.value.trim();
    if (isRecording && text) {
      stopRecording();
      translate(text);
    } else {
      stopRecording();
    }
  };

  try { recognition.start(); } catch(e) { stopRecording(); }
}

function stopRecording() {
  isRecording = false;
  micBtn.classList.remove('recording');
  micBtn.querySelector('span').textContent = 'é»æ“Šèªªè©±';
  if (recognition) { try { recognition.stop(); } catch(e){} }
}

// -- Mic button event (tap to toggle) --
micBtn.addEventListener('click', (e) => {
  e.preventDefault();
  toggleRecording();
});

// -- Text input --
sendBtn.addEventListener('click', () => {
  const t = textInput.value.trim();
  if (!t) return;
  if (!getApiKey()) { showKeyModal(false); return; }
  translate(t);
});
textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const t = textInput.value.trim();
    if (!t) return;
    if (!getApiKey()) { showKeyModal(false); return; }
    translate(t);
  }
});

// -- Translation --
async function translate(text) {
  loading.classList.add('show');
  resultCard.className = 'result-card empty';
  resultCard.innerHTML = '<span>ç¿»è­¯ä¸­...</span>';
  setStatus('');

  try {
    const body = {
      contents: [
        { role: 'user', parts: [{ text: SYSTEM_PROMPT + '\n\nè«‹ç¿»è­¯ï¼š' + text }] }
      ],
      generationConfig: {
        temperature: 0.1,
        maxOutputTokens: 512,
      }
    };

    const resp = await fetch(getGeminiUrl(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error(`API éŒ¯èª¤ (${resp.status}): ${err.substring(0, 200)}`);
    }

    const data = await resp.json();
    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

    // Parse JSON from response (strip possible markdown fences)
    const jsonStr = raw.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    const result = JSON.parse(jsonStr);

    showResult(text, result);
    addHistory(text, result);
    speak(result.translation, result.detected_lang === 'zh' ? 'ja-JP' : 'zh-TW');

  } catch (e) {
    resultCard.className = 'result-card empty';
    resultCard.innerHTML = `<span style="color:var(--danger)">ç¿»è­¯å¤±æ•—<br><small>${e.message}</small></span>`;
    setStatus('');
  }

  loading.classList.remove('show');
}

function showResult(originalText, result) {
  const { translation, romaji, detected_lang } = result;
  resultCard.className = 'result-card';
  const longClass = translation.length > 15 ? ' long' : '';
  resultCard.innerHTML = `
    <div class="translation${longClass}">${esc(translation)}</div>
    ${romaji ? `<div class="romaji">${esc(romaji)}</div>` : ''}
    <div class="original">${detected_lang === 'zh' ? 'ä¸­â†’æ—¥' : 'æ—¥â†’ä¸­'}ï½œ${esc(originalText)}</div>
    <div class="tap-hint">é»æ“Šæ’­æ”¾èªéŸ³</div>
  `;
  resultCard.onclick = () => {
    speak(translation, detected_lang === 'zh' ? 'ja-JP' : 'zh-TW');
  };
}

// -- Camera --
camBtn.addEventListener('click', () => {
  if (!getApiKey()) { showKeyModal(false); return; }
  camInput.value = '';
  camInput.click();
});

camInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  await translatePhoto(file);
});

async function translatePhoto(file) {
  loading.classList.add('show');
  resultCard.className = 'result-card empty';
  resultCard.innerHTML = '<span>è¾¨è­˜ç¿»è­¯ä¸­...</span>';
  setStatus('');

  try {
    const base64 = await fileToBase64(file);
    const mimeType = file.type || 'image/jpeg';

    const body = {
      contents: [{
        role: 'user',
        parts: [
          { inlineData: { mimeType, data: base64 } },
          { text: PHOTO_PROMPT }
        ]
      }],
      generationConfig: { temperature: 0.1, maxOutputTokens: 2048 }
    };

    const resp = await fetch(getGeminiUrl(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error(`API éŒ¯èª¤ (${resp.status}): ${err.substring(0, 200)}`);
    }

    const data = await resp.json();
    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonStr = raw.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    const result = JSON.parse(jsonStr);

    if (!result.lines || result.lines.length === 0) {
      resultCard.className = 'result-card empty';
      resultCard.innerHTML = '<span>æœªåµæ¸¬åˆ°æ–‡å­—</span>';
    } else {
      showPhotoResults(result.lines);
    }

  } catch (e) {
    resultCard.className = 'result-card empty';
    resultCard.innerHTML = `<span style="color:var(--danger)">è¾¨è­˜å¤±æ•—<br><small>${e.message}</small></span>`;
  }

  loading.classList.remove('show');
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function showPhotoResults(lines) {
  resultCard.className = '';
  resultCard.onclick = null;

  let html = `<div class="photo-results">`;
  html += `<div class="photo-results-header">è¾¨è­˜åˆ° ${lines.length} æ®µæ–‡å­—</div>`;

  lines.forEach((line, i) => {
    html += `<div class="photo-line" data-pidx="${i}">`;
    html += `<div class="pl-original">${esc(line.original)}</div>`;
    html += `<div class="pl-translation">${esc(line.translation)}</div>`;
    if (line.romaji) html += `<div class="pl-romaji">${esc(line.romaji)}</div>`;
    html += `</div>`;
  });

  html += `</div>`;
  resultCard.innerHTML = html;

  resultCard.querySelectorAll('.photo-line').forEach(el => {
    el.addEventListener('click', () => {
      const idx = parseInt(el.dataset.pidx);
      const line = lines[idx];
      if (!line) return;
      speak(line.translation, line.detected_lang === 'zh' ? 'ja-JP' : 'zh-TW');
    });
  });
}

// -- TTS --
function speak(text, lang) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  u.rate = 0.9;
  window.speechSynthesis.speak(u);
}

// -- History --
function addHistory(original, result) {
  history.unshift({ original, ...result, time: Date.now() });
  if (history.length > 50) history = history.slice(0, 50);
  localStorage.setItem('translateHistory', JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  if (history.length === 0) { historyContainer.innerHTML = ''; return; }

  let html = '<div class="history-title">ç¿»è­¯ç´€éŒ„</div>';
  history.forEach((item, i) => {
    html += `
      <div class="history-item" data-idx="${i}">
        <div class="h-translation">${esc(item.translation)}</div>
        ${item.romaji ? `<div class="h-romaji">${esc(item.romaji)}</div>` : ''}
        <div class="h-original">${item.detected_lang === 'zh' ? 'ä¸­â†’æ—¥' : 'æ—¥â†’ä¸­'}ï½œ${esc(item.original)}</div>
      </div>`;
  });
  historyContainer.innerHTML = html;

  historyContainer.querySelectorAll('.history-item').forEach(el => {
    el.addEventListener('click', () => {
      const idx = parseInt(el.dataset.idx);
      const item = history[idx];
      if (!item) return;
      showResult(item.original, item);
      speak(item.translation, item.detected_lang === 'zh' ? 'ja-JP' : 'zh-TW');
      mainArea.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function setStatus(msg) { statusEl.textContent = msg; }

// -- Init --
renderHistory();

// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
